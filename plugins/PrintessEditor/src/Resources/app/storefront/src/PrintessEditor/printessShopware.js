import{PrintessEditor}from"./printessEditor";export class PrintessShopwareIntegration{constructor(t,e){this.name=0,this.product=e,(this.settings=t)&&!t.uiSettings&&(t.uiSettings={showStartupAnimation:"boolean"==typeof t.showStartupAnimation&&t.showStartupAnimation,theme:t.theme||null,uiVersion:"classical",startupBackgroundColor:null,startupLogoUrl:t.startupLogoUrl||null}),this.name=Math.random(),console.log(this.name)}getGlobalConfig(){return window&&window.printessGlobalConfig?window.printessGlobalConfig:{}}getProductOptionInputSelector(t){return"input[name='"+t+"'], select[name='"+t+"']"}getVariantInputs(){let i=[];return this.recordForeach(this.product.variantOptions,(t,e)=>{document.querySelectorAll(this.getProductOptionInputSelector(t)).forEach(t=>{i.push(t)})}),i}getCurrentProductOptionsFromProductPage(){var t=this.getVariantInputs();let r={},a={};var e=this.getGlobalConfig();if(e&&e.formFields)for(var i in e.formFields)e.formFields.hasOwnProperty(i)&&(r[i]=e.formFields[i]);return t.forEach(t=>{var e,i=t.getAttribute("name");this.product.variantOptions.hasOwnProperty(i)&&("SELECT"===t.nodeName?(e=t.value,this.product.variantOptions[i].values.hasOwnProperty(e)&&(r[this.product.variantOptions[i].name]=this.product.variantOptions[i].values[e].name,a[i]=!0)):"radio"===t.getAttribute("type")&&(e=t.value,t.checked)&&this.product.variantOptions[i].values.hasOwnProperty(e)&&(r[this.product.variantOptions[i].name]=this.product.variantOptions[i].values[e].name,a[i]=!0))}),r}getCurrentProductOptions(t){return"cart"!==t.displayMode?this.getCurrentProductOptionsFromProductPage():t.basketItemOptions}recordForeach(t,e){let i=-1;for(var r in t)if(t.hasOwnProperty(r)&&!1===e(r,t[r],++i))break}filterVariantRelatedOptions(t){var e,i={};for(e in t)if(t.hasOwnProperty(e)){var r,a=t[e];for(r in this.product.variantOptions)if(this.product.variantOptions.hasOwnProperty(r)){var s=this.product.variantOptions[r];if(s.name===e)for(var n in s.values)s.values.hasOwnProperty(n)&&s.values[n].name===a&&(i[e]=a)}}return i}getVariantByProductOptions(t){let i=this.filterVariantRelatedOptions(t),r=this.product.variants;for(let e in i)i.hasOwnProperty(e)&&(r=r.filter(t=>t.options&&t.options.hasOwnProperty(e)&&t.options[e].optionName===i[e]));return 0<r.length?r[0]:this.product}addOrRemoveTextField(e,i,r,a,s,n=null){if(n=n||this.settings.designNowButtonInstance.closest("form"),Array.isArray(a))a.forEach(t=>{this.addOrRemoveTextField(e,i,r,t,s,n)});else{let t=document.getElementById(a);s?(!t&&n&&((t=document.createElement("input")).setAttribute("id",a),t.setAttribute("name","lineItems["+i+"]["+r+"]"),t.setAttribute("type","hidden"),t.style.display="none",n.appendChild(t)),t&&t.setAttribute("value",s)):t&&t.remove()}}createShopContext(d){let o=this;var t,e,i={templateNameOrSaveToken:"",stickers:[],legalText:this.product.metaData.hasOwnProperty("PrintessLegalText")?this.product.metaData.PrintessLegalText||"":d.priceFormatOptions&&d.priceFormatOptions.legalText?d.priceFormatOptions.legalText:"",legalTextUrl:this.product.metaData.hasOwnProperty("PrintessLegalTextUrl")&&this.product.metaData.PrintessLegalTextUrl||"",snippetPrices:[],chargeEachStickerUsage:!1,hidePricesInEditor:void 0!==o.settings.hidePricesInEditor&&!0===o.settings.hidePricesInEditor,getProductName:()=>o.product.name,formatMoney:t=>{let e=parseFloat(""+t).toFixed(2);var i;return d.priceFormatOptions&&(i={minimumFractionDigits:2,maximumFractionDigits:20},d.priceFormatOptions.rounding&&(i.minimumFractionDigits=d.priceFormatOptions.rounding.decimal,i.maximumFractionDigits=d.priceFormatOptions.rounding.decimal),i={style:"currency",currency:d.priceFormatOptions.currencyIsoCode,...i},e=t.toLocaleString((()=>{var t,e,i;if("object"==typeof navigator)return t="anguage",(i=(e=navigator).languages)&&i.length?i:(t=e["l"+t]||e["browserL"+t]||e["userL"+t])&&[t]})()[0]??"en-US",i)),e},getMergeTemplates:()=>{var e=[];if(this.product.metaData.hasOwnProperty("PrintessMergeTemplates")&&this.product.metaData.PrintessMergeTemplates)try{var t=JSON.parse(this.product.metaData.PrintessMergeTemplates);t&&e.push("string"==typeof t?{templateName:t||""}:t)}catch(t){e.push({templateName:this.product.metaData.hasOwnProperty("PrintessMergeTemplates")&&this.product.metaData.PrintessMergeTemplates||""})}return e},onFormFieldChanged:(n,o,l,p)=>{let i=this.getVariantByProductOptions(this.getCurrentProductOptions(d));if(d.basketItemOptions||(d.basketItemOptions={}),d.basketItemOptions[n]=o,"cart"!==d.displayMode){let a=null,s=null;this.recordForeach(this.product.variantOptions,(t,e)=>{if(e.name===n||e.name===l)for(var i in e.values)if(e.values.hasOwnProperty(i)){var r=e.values[i];if(o===r.name||r.name===p)return a=i,s=e.id,!1}}),null!=a&&null!=s&&document.querySelectorAll(this.getProductOptionInputSelector(s)).forEach(e=>{var t=e.getAttribute("name");if(this.product.variantOptions.hasOwnProperty(t))if("SELECT"===e.nodeName){e.value=a;for(let t=0;t<e.options.length;++t)e.options[t].selected=e.options[t].value===a}else"radio"===e.getAttribute("type")&&(e.checked=e.value===a)});var t=document.querySelectorAll("[name^='lineItems\\["+i.id+"]'");let e="lineItems["+i.id+"]";i=this.getVariantByProductOptions(this.getCurrentProductOptions(d)),t.forEach(t=>{t.getAttribute("name")===e+"[id]"&&(t.value=i.id),t.setAttribute("name",t.getAttribute("name").replace(e,"lineItems["+i.id+"]"))})}},onAddToBasket:(i,r)=>{if("cart"===d.displayMode){var t=document.getElementById("printessupdateLineItem"+d.lineItemId);if(t){var e=t.querySelector("input[name='lineItems\\[id\\]'],input[name='lineItems\\[0\\]\\[id\\]']"),a=t.querySelector("input[name='lineItems\\[quantity\\]'],input[name='lineItems\\[0\\]\\[quantity\\]']"),s=t.querySelector("input[name='lineItems\\[referencedId\\]'],input[name='lineItems\\[0\\]\\[referencedId\\]']"),n=t.querySelector("input[name='lineItems\\[payload\\]'],input[name='lineItems\\[0\\]\\[payload\\]']"),e=(e&&(e.value=d.lineItemId),a&&(a.value=d.lineItem.quantity.toString()),s&&(s.value=d.lineItem.referencedId),n&&(n.value=JSON.stringify({_printessProductOptions:d.basketItemOptions,_printessSaveToken:i,_printessThumbnailUrl:r})),this.getGlobalConfig());if(e&&"function"==typeof e.onAddToBasket)try{e.onAddToBasket(i,r)}catch(t){console.error(t)}t.submit()}}else{let e=this.getVariantByProductOptions(o.getCurrentProductOptions(d));a=this.settings.designNowButtonInstance.closest("form"),s=(this.addOrRemoveTextField(d,e.id,"_printessSaveToken","printess_save_token_input_"+e.id,i,a),this.addOrRemoveTextField(d,e.id,"_printessThumbnailUrl","printess_thumbnail_url_input_"+e.id,r,a),this.addOrRemoveTextField(d,e.id,"_printessProductOptions","printess_product_options_"+e.id,JSON.stringify({...d.basketItemOptions||{},...this.getCurrentProductOptionsFromProductPage()}),a),document.getElementsByName("lineItems["+e.id+"][stackable]"));s&&s.forEach(t=>t.value="0");let t=document.getElementsByName("lineItems["+e.id+"][id]");t&&t.forEach(t=>t.value=""+e.id),(t=document.getElementsByName("lineItems["+e.id+"][referencedId]"))&&t.forEach(t=>t.value=""+e.id);n=this.getGlobalConfig();if(n&&"function"==typeof n.onAddToBasket)try{n.onAddToBasket(i,r)}catch(t){console.error(t)}this.settings.addToBasketButtonInstance&&this.settings.addToBasketButtonInstance.click()}},getCurrentFormFieldValues:()=>o.getCurrentProductOptions(d),getPriceForFormFields:t=>{var e=o.getVariantByProductOptions(o.getCurrentProductOptions(d)),i=e.price[0].gross;return d.priceFormatOptions&&!d.priceFormatOptions.grossPrice&&e.price[0].net,i},getFormFieldMappings:()=>{let t={};if(this.product.metaData.hasOwnProperty("PrintessFormFieldMappings")&&this.product.metaData.PrintessFormFieldMappings)try{t=JSON.parse(this.product.metaData.PrintessFormFieldMappings)}catch(t){console.error(t)}return t},getPriceInfo:()=>null,editorClosed:t=>{}};return d.saveToken?i.templateNameOrSaveToken=d.saveToken:(t=this.getCurrentProductOptions(d),e=this.getVariantByProductOptions(t),i.templateNameOrSaveToken=this.doDisplayDesignNowButton(t)?e.metaData.PrintessTemplateName||this.product.metaData.PrintessTemplateName:this.product.metaData.PrintessTemplateName||""),i}doDisplayDesignNowButton(t){let e=!1;this.product.variants.forEach(t=>{e=e||t.metaData.hasOwnProperty("PrintessTemplateName")&&t.metaData.PrintessTemplateName&&!0});t=this.getVariantByProductOptions(t);return e?t.metaData.hasOwnProperty("PrintessTemplateName")&&t.metaData.PrintessTemplateName&&!0:this.product.metaData.hasOwnProperty("PrintessTemplateName")&&this.product.metaData.PrintessTemplateName&&!0}showDesignNowButton(t){this.settings.designNowButtonInstance&&this.settings.addToBasketButtonInstance&&(this.settings.addToBasketButtonInstance.getAttribute("data-orig-display")||this.settings.addToBasketButtonInstance.setAttribute("data-orig-display",this.settings.addToBasketButtonInstance.style.display),this.settings.addToBasketButtonInstance.style.display=t?"none":this.settings.addToBasketButtonInstance.getAttribute("data-orig-display"),this.settings.designNowButtonInstance.style.display=t?"inline-block":"none")}initProductPage(){this.showDesignNowButton(this.doDisplayDesignNowButton(this.getCurrentProductOptionsFromProductPage()))}show(t){"cart"!==t.displayMode&&(r=this.settings.designNowButtonInstance.closest("form"))&&(r=r.querySelector("input[name^='lineItems\\['][name$='\\]\\[id\\]']"))&&(r=r.getAttribute("name").replace("lineItems[","").replace("][id]",""),t.lineItemId=r);var e=this.getGlobalConfig();if(e&&e.attachParams)for(var i in e.attachParams)e.attachParams.hasOwnProperty(i)&&(this.settings.attachParams||(this.settings.attachParams={}),this.settings.attachParams[i]=e.attachParams[i]);var r=this.createShopContext(t);new PrintessEditor(this.settings).show(r)}};