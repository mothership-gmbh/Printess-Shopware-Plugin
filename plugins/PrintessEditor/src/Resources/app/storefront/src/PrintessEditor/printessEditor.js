export class PrintessEditor{constructor(e){if(this.calculateCurrentPrices=async(e,t)=>{var i=await this.getPriceCategories(t);let n=i.basePrice;return e.snippetPriceCategories&&e.snippetPriceCategories.forEach(e=>{e&&0<e.amount&&t.snippetPrices[e.priceCategory-1]&&(n+=t.snippetPrices[e.priceCategory-1].priceInCent)}),i.price=t.formatMoney(n),i},!e||!e.shopToken)throw"No shop token provided";this.Settings={...e};e={};null!=this.Settings.uiSettings&&(e.showAnimation=!0===this.Settings.uiSettings.showStartupAnimation||"true"==this.Settings.uiSettings.showStartupAnimation,this.Settings.uiSettings.startupLogoUrl&&(e.imageUrl=this.Settings.uiSettings.startupLogoUrl),this.Settings.uiSettings.startupBackgroundColor)&&(e.background=this.Settings.uiSettings.startupBackgroundColor),this.ClassicEditorUrl=this.getClassicEditorUrl(this.Settings.editorUrl,this.Settings.editorVersion,e)+"#"+encodeURIComponent(JSON.stringify(e))}stripEditorVersion(e){if(void 0!==(e=(e||"").trim())&&null!=e)if(e){for(;0==e.indexOf("/");)e=e.substring(1);for(;0<e.length&&"/"===e[e.length-1];)e=e.substring(0,e.length-1)}else e="";return e}sanitizeHost(e){return e?(e=e.trim()).endsWith("/")?e:e+"/":e||""}getClassicEditorUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var s=e.substring(n+1);if(s)try{var o=JSON.parse(decodeURIComponent(s));if(o)for(var a in o)o.hasOwnProperty(a)&&(i[a]=o[a])}catch(e){}e=e.substring(0,n)}return e.toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e+="printess-editor/embed.html"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getLoaderUrl(e,t,i){var n=(e=e||"https://editor.printess.com/").indexOf("#");if(0<n){var s=e.substring(n+1);if(s)try{var o=JSON.parse(decodeURIComponent(s));if(o)for(var a in o)o.hasOwnProperty(a)&&(i[a]=o[a])}catch(e){}e=e.substring(0,n)}return(e=e.toLocaleLowerCase().endsWith("embed.html")?e.substring(0,e.length-"embed.html".length):e).toLowerCase().endsWith(".html")||(e=this.sanitizeHost(e),t&&(e+=(t=this.stripEditorVersion(t))+(t?"/":"")),e.toLowerCase().endsWith("printess-editor/")||(e+="printess-editor/"),e+="loader.js"),e=0!==e.toLowerCase().indexOf("https://")&&0!==e.toLowerCase().indexOf("http://")?"https://"+e:e}getPrintessComponent(){return document.querySelector("printess-component")||null}applyFormFieldMappings(t,i){var n=[];if(!i)for(var e in t)t.hasOwnProperty(e)&&n.push({name:e,value:t[e]});if(t)for(var s in t)if(t.hasOwnProperty(s)){var o=t[s],a=void 0!==i[s]&&void 0!==i[s].formField?i[s].formField:s;let e=o;void 0!==i[s]&&void 0!==i[s].values&&void 0!==i[s].values[e]&&(e=i[s].values[o]),n.push({name:a,value:e})}return n}reverseFormFieldMapping(e,t,i){let n=e||"",s=t||"";if(i)for(var o in i)if(i.hasOwnProperty(o)&&i[o].formField===e){if(i[n=o].values)for(var a in i[o].values)if(i[o].values.hasOwnProperty(a)&&i[o].values[a]===t){s=a;break}break}return{name:n,value:s}}setViewportMeta(){var i=document.getElementsByTagName("head");if(i&&0<i.length){let e=i[0].querySelector("meta[name=viewport]"),t=(e||((e=document.createElement("meta")).setAttribute("name","viewport"),i[0].appendChild(e)),e.getAttribute("content"));t?t.indexOf("interactive-widget")<0&&(t=t+(t?", ":"")+"interactive-widget=resizes-content",e.setAttribute("content",t)):e.setAttribute("content","interactive-widget=resizes-content")}}async initializeIFrame(t,i,n){let s=this,o=document.getElementById("printess"),a=e=>{t&&"function"==typeof t.onCloseTab&&t.onCloseTab(e)},r=e=>{switch(e.data.cmd){case"back":window.removeEventListener("message",r),window.removeEventListener("beforeunload",a),window.removeEventListener("unload",a),o.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onBack&&t.onBack();break;case"basket":window.removeEventListener("message",r),window.removeEventListener("beforeunload",a),window.removeEventListener("unload",a),o.setAttribute("printessHasListener","false"),t&&"function"==typeof t.onAddToBasketAsync&&t.onAddToBasketAsync(e.data.token,e.data.thumbnailUrl).then(()=>{});break;case"formFieldChanged":t&&"function"==typeof t.onFormFieldChangedAsync&&t.onFormFieldChangedAsync(e.data.n||e.data.name,e.data.v||e.data.value,e.data.ffCaption||"",e.data.l||e.data.label).then(()=>{});break;case"priceChanged":t&&"function"==typeof t.onPriceChangedAsync&&t.onPriceChangedAsync(e.data.priceInfo).then(()=>{});break;case"renderFirstPageImage":t&&"function"==typeof t.onRenderedFirstPageImageAsync&&t.onRenderedFirstPageImageAsync(e.data.result);break;case"save":t&&"function"==typeof t.onSaveAsync&&t.onSaveAsync(e.data.token);case"load":t&&"function"==typeof t.onLoadAsync&&t.onLoadAsync(i.templateNameOrSaveToken)}};return new Promise(e=>{var t;o?("true"!==o.getAttribute("printessHasListener")&&(window.addEventListener("message",r),!0===n.showAlertOnTabClose&&(window.addEventListener("beforeunload",a),window.addEventListener("unload",a)),o.setAttribute("printessHasListener","true")),e(o)):((t=document.createElement("div")).setAttribute("id","printess-container"),t.setAttribute("style","display: none; position: absolute; top: 0; bottom: 0; right: 0; left: 0; width: 100%; height: 100%; z-index: 100000;"),(o=document.createElement("iframe")).setAttribute("src",this.ClassicEditorUrl),o.setAttribute("id","printess"),o.setAttribute("style","width:100%; heigth:100%;"),o.setAttribute("data-attached","false"),o.setAttribute("allow","xr-spatial-tracking; clipboard-read; clipboard-write;"),o.setAttribute("allowfullscreen","true"),o.classList.add("printess-owned"),t.appendChild(o),o.onload=()=>{e(o)},window.addEventListener("message",r),!0===n.showAlertOnTabClose&&(window.addEventListener("beforeunload",a),window.addEventListener("unload",a)),o.setAttribute("printessHasListener","true"),window.visualViewport&&window.visualViewport.addEventListener("scroll",()=>{o.contentWindow?.postMessage({cmd:"viewportScroll",height:window.visualViewport?.height,offsetTop:window.visualViewport?.offsetTop},"*")},{passive:!0}),s.setViewportMeta(),document.body.append(t))})}async getPriceCategories(e,t=null){let i=0;return t=t||e.getCurrentFormFieldValues(),"function"==typeof e.getPriceForFormFieldsAsync?i=await e.getPriceForFormFieldsAsync(t):"function"==typeof e.getPriceForFormFields&&(i=e.getPriceForFormFields(t)),{snippetPrices:e.snippetPrices.map(e=>e?e.label:null),priceCategories:{},price:e.formatMoney(i),basePrice:i,productName:e.getProductName(),legalNotice:e.legalText,infoUrl:e.legalTextUrl}}async onPriceChanged(i,n){try{let e=null;try{i.snippetPriceCategories&&0<i.snippetPriceCategories.length?n.stickers=i.snippetPriceCategories.filter(e=>n.snippetPrices&&n.snippetPrices.length>=e.priceCategory).map(e=>({productVariantId:n.snippetPrices[e.priceCategory-1].variantId,quantity:e.amount})):n.stickers=[],e=await this.calculateCurrentPrices(i,n)}catch(e){console.error(e)}let t=document.getElementById("printess");t&&!n.hidePricesInEditor&&setTimeout(()=>{t.contentWindow.postMessage({cmd:"refreshPriceDisplay",priceDisplay:e},"*")},0);var s=this.getPrintessComponent();s&&s.editor&&s.editor.ui.refreshPriceDisplay(e)}catch(e){}}hideBcUiVersion(e,t){var i=this.getPrintessComponent();i&&i.editor&&i.editor.ui.hide(),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}async showBcUiVersion(i,o){let n=this;var e=i.getPriceInfo();let s=null,a=null;i&&i.templateNameOrSaveToken&&0===i.templateNameOrSaveToken.indexOf("st:")||(s=n.applyFormFieldMappings(i.getCurrentFormFieldValues(),i.getFormFieldMappings()),a=i.getMergeTemplates());var r=n.getLoaderUrl(this.Settings.editorUrl,this.Settings.editorVersion,{}),r=await import(/* webpackIgnore: true */r);let d=n.getPrintessComponent();if(d&&d.editor)d.style.display="block",i.renderFirstPageImageAsync=async(e,t)=>{e=await d.editor.api.renderFirstPageImage("thumbnail.png",void 0,e,t);i&&"function"==typeof i.onRenderFirstPageImageAsync?await i.onRenderFirstPageImageAsync(e):i&&"function"==typeof i.onRenderFirstPageImage&&i.onRenderFirstPageImage(e)},await d.editor.api.loadTemplateAndFormFields(i.templateNameOrSaveToken,a,s,null),d.editor.ui.show();else{let t={domain:n.Settings.apiDomain,mergeTemplates:a,formFields:s,token:n.Settings.shopToken,templateName:i.templateNameOrSaveToken,translationKey:"",basketId:"function"==typeof i.getBasketId&&i.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof i.getUserId?i.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",snippetPriceCategoryLabels:e&&e.snippetPrices?e.snippetPrices:null,theme:n.Settings.uiSettings&&n.Settings.uiSettings.theme||"",addToBasketCallback:(e,t)=>{o&&"function"==typeof o.onAddToBasketAsync&&o.onAddToBasketAsync(e,t).then(()=>{})},formFieldChangedCallback:(e,t,i,n,s)=>{o&&"function"==typeof o.onFormFieldChangedAsync&&o.onFormFieldChangedAsync(e,t,s,n).then(()=>{})},priceChangeCallback:e=>{o&&"function"==typeof o.onPriceChangedAsync&&o.onPriceChangedAsync(e).then(()=>{})},backButtonCallback:e=>{n.hideBcUiVersion(i,!0)},saveTemplateCallback:(e,t)=>{"function"==typeof o.onSaveAsync&&o.onSaveAsync(e)},loadTemplateCallback:e=>{o.onLoadAsync(t.templateName)}};e=await r.load(t);(d=n.getPrintessComponent())&&(d.editor=e)}}async show(s){let o=this;var n=s&&s.templateNameOrSaveToken&&0===s.templateNameOrSaveToken.indexOf("st:"),a={onBack:()=>{o.hide(s,!0)},onAddToBasketAsync:async(e,t)=>{let i=null;(i="function"==typeof s.onAddToBasketAsync?await s.onAddToBasketAsync(e,t):s.onAddToBasket(e,t))&&i.waitUntilClosingMS?setTimeout(function(){"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),o.hide(s,!1)},i.waitUntilClosingMS):(i&&"function"==typeof i.executeBeforeClosing&&i.executeBeforeClosing(),o.hide(s,!1))},onFormFieldChangedAsync:async(e,t,i,n)=>{e=o.reverseFormFieldMapping(e,t,s.getFormFieldMappings());"function"==typeof s.onFormFieldChangedAsync?await s.onFormFieldChanged(e.name,e.value,i,n):"function"==typeof s.onFormFieldChanged&&s.onFormFieldChanged(e.name,e.value,i,n)},onPriceChangedAsync:async e=>{await o.onPriceChanged(e,s)},onRenderedFirstPageImageAsync:async e=>{"function"==typeof s.onRenderFirstPageImageAsync?await s.onRenderFirstPageImageAsync(e):"function"==typeof s.onRenderFirstPageImage&&s.onRenderFirstPageImage(e)},onSaveAsync:async e=>{"function"==typeof s.onSaveAsync?await s.onSaveAsync(e,""):"function"==typeof s.onSave&&s.onSave(e,"")},onLoadAsync:async e=>{"function"==typeof s.onLoadAsync?await s.onLoadAsync(e):"function"==typeof s.onLoad&&s.onLoad(e)},onCloseTab:e=>{e.preventDefault(),e.returnValue=""}};if(this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion)o.showBcUiVersion(s,a);else{var r=s.getPriceInfo();let e=null,t=null,i=(n||(e=this.applyFormFieldMappings(s.getCurrentFormFieldValues(),s.getFormFieldMappings()),t=s.getMergeTemplates()),await this.initializeIFrame(a,s,this.Settings));if(s.renderFirstPageImageAsync=(e,t)=>(setTimeout(function(){i.contentWindow.postMessage({cmd:"renderFirstPageImage",properties:{}},"*")},0),Promise.resolve()),"false"===i.getAttribute("data-attached"))try{var d={domain:o.Settings.apiDomain,token:this.Settings.shopToken||"",templateName:s.templateNameOrSaveToken,showBuyerSide:!0,templateUserId:"",basketId:"function"==typeof s.getBasketId&&s.getBasketId()||"Some-Unique-Basket-Or-Session-Id",shopUserId:"function"==typeof s.getUserId?s.getUserId()||"Some-Unique-Basket-Or-Session-Id":"Some-Unique-Shop-User-Id",formFields:e,snippetPriceCategoryLabels:r&&r.snippetPrices?r.snippetPrices:null,mergeTemplates:t};if(null!=s.showSplitterGridSizeButton&&(d.showSplitterGridSizeButton=!0===s.showSplitterGridSizeButton||"true"===s.showSplitterGridSizeButton),this.Settings.uiSettings&&this.Settings.uiSettings.theme&&(d.theme=this.Settings.uiSettings.theme),this.Settings.attachParams)for(var l in this.Settings.attachParams)this.Settings.attachParams.hasOwnProperty(l)&&(d[l]=this.Settings.attachParams[l]);if(void 0!==s.additionalAttachParams||null!==s.additionalAttachParams)for(var c in s.additionalAttachParams)s.additionalAttachParams.hasOwnProperty(c)&&(d[c]=s.additionalAttachParams[c]);i.contentWindow.postMessage({cmd:"attach",properties:d},"*"),i.setAttribute("data-attached","true"),setTimeout(function(){i.contentWindow.focus()},0)}catch(e){console.error(e)}else{n={templateNameOrToken:s.templateNameOrSaveToken,mergeTemplates:t,formFields:e,snippetPriceCategoryLabels:r&&r.snippetPrices?r.snippetPrices:null,formFieldProperties:void 0,clearExchangeCaches:!0};this.Settings.attachParams&&(this.Settings.attachParams.formFieldProperties&&(n.formFieldProperties=this.Settings.attachParams.formFieldProperties),void 0!==this.Settings.attachParams.clearExchangeCaches)&&(n.clearExchangeCaches=!1!==this.Settings.attachParams.clearExchangeCaches),s&&s.additionalAttachParams&&(s.additionalAttachParams.formFieldProperties&&(n.formFieldProperties=s.additionalAttachParams.formFieldProperties),void 0!==s.additionalAttachParams.clearExchangeCaches)&&(n.clearExchangeCaches=!1!==s.additionalAttachParams.clearExchangeCaches),i.contentWindow.postMessage({cmd:"loadTemplateAndFormFields",parameters:[n.templateNameOrToken,n.mergeTemplates,n.formFields,n.snippetPriceCategoryLabels,n.formFieldProperties,n.clearExchangeCaches]},"*"),setTimeout(function(){i.contentWindow.focus()},0)}}document.body.classList.add("hideAll");a=document.getElementsByTagName("html"),a&&0<a.length&&a[0].classList.add("printess-editor-open"),r=document.getElementById("printess-container");r&&r.style.setProperty("display","block","important")}hide(e,t){this.Settings.uiSettings&&"bcui"===this.Settings.uiSettings.uiVersion?(i=this.getPrintessComponent())&&i.editor&&i.editor.ui.hide():(i=document.getElementById("printess-container"))&&(i.style.display="none"),document.body.classList.remove("hideAll");var i=document.getElementsByTagName("html");i&&0<i.length&&i[0].classList.remove("printess-editor-open"),"function"==typeof e.editorClosed&&e.editorClosed(!0===t)}static getGlobalShopSettings(){return window&&window.printessGlobalConfig?window.printessGlobalConfig:{}}static getGlobalFormFields(){var e=PrintessEditor.getGlobalShopSettings();let t;if(null!=typeof e.formFields&&e.formFields)if("function"==typeof e.formFields)try{t=e.formFields()}catch(e){console.error(e)}else t=e.formFields;return t||{}}}function initPrintessEditor(e,t,i,n,s,o,a=""){let r;return r=e&&"string"!=typeof e?{apiDomain:e.apiDomain||null,shopToken:e.shopToken||"",editorUrl:e.editorUrl||"",editorVersion:e.editorVersion||"",attachParams:e.attachParams||"",showAlertOnTabClose:null!=e.showTabClosingAlert&&!0===e.showTabClosingAlert,uiSettings:{showStartupAnimation:null==e.showStartupAnimation||!0===e.showStartupAnimation,startupBackgroundColor:e.startupBackgroundColor||"#ffffff",theme:e.theme||"",startupLogoUrl:e.startupLogoUrl||"",uiVersion:e.uiVersion||""},...e}:{apiDomain:null,shopToken:e||"",editorUrl:t,editorVersion:i,uiSettings:{showStartupAnimation:s,startupBackgroundColor:a,startupLogoUrl:n,theme:o}},new PrintessEditor(r)};